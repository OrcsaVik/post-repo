
# Kubernetes ä¸ DevOps æ¶æ„å®æˆ˜æŒ‡å—

æœ¬æŒ‡å—åŸºäºå®¹å™¨åŒ–ç®¡ç†ä¸è‡ªåŠ¨åŒ–è¿ç»´çš„æ ¸å¿ƒç†å¿µï¼Œæç‚¼ Kubernetes æ¶æ„ç»„ä»¶ä¸ DevOps æŒç»­é›†æˆ/æŒç»­éƒ¨ç½²ï¼ˆCI/CDï¼‰çš„å·¥ç¨‹å®è·µè¦ç‚¹ï¼Œæ—¨åœ¨å¸®åŠ©å¼€å‘è€…æ„å»ºé«˜å¯ç”¨çš„å®¹å™¨åŒ–è¿ç»´ä½“ç³»ã€‚

------

## ä¸€ã€ Kubernetes æ ¸å¿ƒæ¶æ„ä¸ç»„ä»¶

Kubernetes (K8s) æ˜¯ä¸€ä¸ªç”¨äºè‡ªåŠ¨éƒ¨ç½²ã€æ‰©å±•å’Œç®¡ç†å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„å¼€æºç³»ç»Ÿã€‚

### 1. æ ¸å¿ƒæ¶æ„åˆ†å¸ƒ

Kubernetes é›†ç¾¤ç”± **Masterï¼ˆæ§åˆ¶å¹³é¢ï¼‰** å’Œ **Nodeï¼ˆå·¥ä½œèŠ‚ç‚¹ï¼‰** ç»„æˆã€‚

| **è§’è‰²**   | **ç»„ä»¶åç§°**                | **æ ¸å¿ƒèŒè´£**                                       |
| ---------- | --------------------------- | -------------------------------------------------- |
| **Master** | **kube-apiserver**          | é›†ç¾¤æ§åˆ¶çš„å”¯ä¸€å…¥å£ï¼Œæ‰€æœ‰ç»„ä»¶é€šä¿¡çš„æ¢çº½ã€‚           |
|            | **etcd**                    | é«˜å¯ç”¨çš„é”®å€¼å­˜å‚¨ï¼Œä¿å­˜é›†ç¾¤æ‰€æœ‰çŠ¶æ€æ•°æ®ã€‚           |
|            | **kube-scheduler**          | èµ„æºè°ƒåº¦ï¼Œè´Ÿè´£å†³å®š Pod è¿è¡Œåœ¨å“ªä¸ª Nodeã€‚           |
|            | **kube-controller-manager** | æ•…éšœæ£€æµ‹ã€è‡ªåŠ¨æ‰©å±•ã€æ»šåŠ¨æ›´æ–°ç­‰é›†ç¾¤æ§åˆ¶ä¸­å¿ƒã€‚       |
| **Node**   | **kubelet**                 | ä»£ç†äººï¼Œè´Ÿè´£ç»´æŠ¤å®¹å™¨ç”Ÿå‘½å‘¨æœŸï¼ˆä¸å®¹å™¨è¿è¡Œæ—¶äº¤äº’ï¼‰ã€‚ |
|            | **kube-proxy**              | å®ç°é›†ç¾¤æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡çš„æµé‡è½¬å‘ã€‚             |
|            | **Docker / Runtime**        | å®¹å™¨è¿è¡Œç¯å¢ƒã€‚                                     |
|            | **Fluentd**                 | æ—¥å¿—æ”¶é›†æ’ä»¶ã€‚                                     |

------

## ğŸ—ï¸ äºŒã€ Kubernetes é›†ç¾¤æ„å»ºæ–¹æ¡ˆ

æ„å»º K8s é›†ç¾¤åº”æ ¹æ®ç¯å¢ƒè§„æ¨¡é€‰æ‹©åˆé€‚çš„å·¥å…·ã€‚

### 1. æ„å»ºå·¥å…·é€‰å‹

- **kubeadm (å®˜æ–¹æ¨è)**ï¼šæœ€é€šç”¨çš„å·¥å…·ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒè‡ªå»ºï¼Œæµç¨‹æ ‡å‡†ã€‚
- **K3s**ï¼šè½»é‡çº§ï¼Œé€‚åˆè¾¹ç¼˜è®¡ç®—ã€IoT æˆ–èµ„æºå—é™çš„å¼€å‘ç¯å¢ƒã€‚
- **RKE / Kubespray**ï¼šåŸºäº Ansibleï¼Œé€‚åˆå¤§è§„æ¨¡é›†ç¾¤çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚

### 2. æ ‡å‡†æ„å»ºæµç¨‹ (kubeadm)

1. **åŸºç¡€è®¾æ–½å‡†å¤‡**ï¼šå…³é—­ Swapã€é…ç½®é™æ€ IPã€åŒæ­¥ç³»ç»Ÿæ—¶é—´ã€å¼€å¯æ¡¥æ¥ç½‘ç»œæ”¯æŒã€‚

2. **å®‰è£…è¿è¡Œæ—¶**ï¼šå®‰è£… Docker æˆ– Containerdã€‚

3. **å®‰è£…ç»„ä»¶**ï¼šå®‰è£… `kubelet`, `kubeadm`, `kubectl`ã€‚

4. **åˆå§‹åŒ– Master**ï¼š

   Bash

   ```
   kubeadm init --pod-network-cidr=10.244.0.0/16 --image-repository registry.aliyuncs.com/google_containers
   ```

5. **é…ç½®ç½‘ç»œæ’ä»¶**ï¼šå®‰è£… Flannel æˆ– Calico ä»¥å®ç° Pod é—´é€šä¿¡ã€‚

6. **Node åŠ å…¥é›†ç¾¤**ï¼šåœ¨ä»èŠ‚ç‚¹æ‰§è¡Œ Master ç”Ÿæˆçš„ `kubeadm join` å‘½ä»¤ã€‚

------

## âŒ¨ï¸ ä¸‰ã€ Kubernetes æ ¸å¿ƒå‘½ä»¤è¡Œ (kubectl)

`kubectl` æ˜¯ç®¡ç†é›†ç¾¤çš„å”¯ä¸€â€œç‘å£«å†›åˆ€â€ï¼Œç†Ÿç»ƒæŒæ¡è¯Šæ–­ä¸éƒ¨ç½²å‘½ä»¤æ˜¯è¿ç»´åŸºç¡€ã€‚

### 1. èµ„æºæŸ¥çœ‹ä¸è¯Šæ–­

Bash

```
# æŸ¥çœ‹æ‰€æœ‰ Node çŠ¶æ€
kubectl get nodes

# æŸ¥çœ‹ Pod è¯¦æƒ…åŠäº‹ä»¶ï¼ˆæ’æŸ¥ 404/CrashLoopBackOff å¿…ç”¨ï¼‰
kubectl describe pod <pod-name>

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
kubectl logs -f <pod-name>
```

### 2. éƒ¨ç½²ä¸ä¼¸ç¼©

Bash

```
# éƒ¨ç½²ä¸€ä¸ªåº”ç”¨
kubectl apply -f deployment.yaml

# åŠ¨æ€æ‰©å®¹ Pod æ•°é‡åˆ° 5 ä¸ª
kubectl scale deployment <deploy-name> --replicas=5

# è¿›å…¥ Pod å†…éƒ¨æ‰§è¡Œå‘½ä»¤
kubectl exec -it <pod-name> -- /bin/bash
```

------

## ğŸ”„ å››ã€ DevOps ç†è®ºä¸ CI/CD æµæ°´çº¿è®¾è®¡

DevOps é€šè¿‡è‡ªåŠ¨åŒ–æ‰‹æ®µè¿æ¥è½¯ä»¶å¼€å‘ï¼ˆDevï¼‰å’Œ IT è¿ç»´ï¼ˆOpsï¼‰ã€‚å°†ä»£ç ä»ä»“åº“å˜æˆ K8s è¿è¡Œä¸­çš„ Podï¼Œæ ¸å¿ƒåœ¨äºè‡ªåŠ¨åŒ–æµç¨‹ã€‚

### 1. CI/CD æ ¸å¿ƒé“¾è·¯

- **CI (æŒç»­é›†æˆ)**ï¼šå¼€å‘è€…é¢‘ç¹åˆå¹¶ä»£ç ï¼Œé€šè¿‡è‡ªåŠ¨åŒ–æµ‹è¯•å‘ç°é”™è¯¯ã€‚
- **CD (æŒç»­äº¤ä»˜)**ï¼šè‡ªåŠ¨éƒ¨ç½²åˆ°ç±»ç”Ÿäº§ç¯å¢ƒï¼ˆStagingï¼‰ï¼Œç¡®ä¿ä»£ç éšæ—¶å¯å‘å¸ƒã€‚
- **CD (æŒç»­éƒ¨ç½²)**ï¼šé€šè¿‡å®¡æ ¸çš„ä»£ç ç›´æ¥è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚

### 2. æµæ°´çº¿å·¥ä½œæµ (Pipeline)

å…¸å‹çš„ Pipeline æµç¨‹å¦‚ä¸‹ï¼š

1. **ä»£ç æäº¤**ï¼šPush ä»£ç è‡³ Gitee/GitHubã€‚

2. **è§¦å‘æ„å»º**ï¼šJenkins ç›‘å¬ Webhook æˆ–æ‰‹åŠ¨è§¦å‘æµæ°´çº¿ã€‚

3. **å•å…ƒæµ‹è¯•ä¸æ‰“åŒ…**ï¼šä½¿ç”¨ Maven è¿›è¡Œå•å…ƒæµ‹è¯•å¹¶æ‰“æˆ Jar åŒ…ã€‚

4. **é•œåƒåŒ–ä¸æ¨é€**ï¼šç¼–å†™ `Dockerfile` å°è£…åº”ç”¨å¹¶æ¨é€è‡³é•œåƒä»“åº“ï¼ˆå¦‚é˜¿é‡Œäº‘/Harborï¼‰ã€‚

   Dockerfile

   ```
   FROM openjdk:8-jre-slim
   COPY target/app.jar /app.jar
   ENTRYPOINT ["java", "-jar", "/app.jar"]
   ```

5. **K8s éƒ¨ç½²**ï¼šæ›´æ–° Deployment èµ„æºï¼Œå®ç°æ»šåŠ¨å‡çº§ã€‚

   Bash

   ```
   kubectl set image deployment/myapp-deploy myapp=registry.cn-hangzhou.aliyuncs.com/repo/myapp:v2.0
   ```

------

## ğŸ› ï¸ äº”ã€ Jenkinsfile ä¸é…ç½®ç®¡ç†

åœ¨ Kubernetes åœºæ™¯ä¸‹ï¼Œæ¨èä½¿ç”¨ **Jenkinsfile (Pipeline as Code)** æ¥ç®¡ç†æ„å»ºæµç¨‹ã€‚

### 1. Jenkins å‡†å¤‡å·¥ä½œ

- **å‡­æ®é…ç½®**ï¼šåœ¨ Jenkins ä¸­åˆ›å»º Docker ä»“åº“ã€Git è´¦å·ç­‰å‡­æ®ï¼ˆCredentialï¼‰ã€‚
- **é¡¹ç›®é…ç½®**ï¼šä¿®æ”¹ `Jenkinsfile` å…³é”®å‚æ•°ï¼Œç¡®ä¿ç¯å¢ƒä¸€è‡´æ€§ã€‚

::: tip æœ€ä½³å®è·µï¼šä½¿ç”¨ç¯å¢ƒå˜é‡

åœ¨ Jenkins ä¸­å®šä¹‰å…¨å±€å˜é‡ï¼ˆå¦‚ DOCKER_CREDENTIAL_IDï¼‰ï¼Œå¯ä»¥æ˜¾è‘—æé«˜æµæ°´çº¿çš„å¯ç§»æ¤æ€§ã€‚

:::

### 2. å­˜å‚¨ä¸é…ç½®ç®¡ç† (ConfigMap)

ç”¨äºè§£è€¦ Pod ä¸é…ç½®ï¼Œç¡®ä¿ç¯å¢ƒä¸€è‡´æ€§ã€‚

- **åº”ç”¨ç¤ºä¾‹**ï¼šéƒ¨ç½² MySQL æ—¶ï¼Œé€šè¿‡ `volumes` æŒ‚è½½å­˜å‚¨åœ¨ K8s ä¸­çš„ `my.cnf` é…ç½®ï¼Œæ— éœ€ä¸ºæ¯ä¸ªå®¹å™¨æ‰‹åŠ¨åˆ›å»ºæ–‡ä»¶ã€‚

::: info é…ç½®ç¤ºä¾‹

Key: master-mysql.cnf

Value: åŒ…å« server-id=1, log-bin=mysql-bin, character-set-server=utf8 ç­‰é…ç½®ã€‚

:::

------

## ğŸ›¡ï¸ å…­ã€ å·¥ç¨‹é¿å‘æŒ‡å— (Best Practices)

::: danger æ ¸å¿ƒå®‰å…¨ä¸ç¨³å®šæ€§

- **æ•°æ®æŒä¹…åŒ–**ï¼šä¸è¦åœ¨ Node ä¸Šå­˜æ•°æ®ï¼Œå¿…é¡»ä½¿ç”¨ **PVC (Persistent Volume Claims)** æŒ‚è½½å¤–éƒ¨å­˜å‚¨ã€‚

- **èµ„æºé…é¢ (Resource Quotas)**ï¼šå¿…é¡»ä¸ºæ¯ä¸ª Pod è®¾ç½® `requests` å’Œ `limits`ï¼Œé˜²æ­¢å•ä¸ªåº”ç”¨è€—å°½èŠ‚ç‚¹èµ„æºã€‚

- å¥åº·æ£€æŸ¥ï¼šé…ç½® LivenessProbe (å­˜æ´»æ£€æŸ¥) å’Œ ReadinessProbe (å°±ç»ªæ£€æŸ¥)ï¼Œé¿å…æµé‡å‘å¾€å¼‚å¸¸å®¹å™¨ã€‚

  :::

::: tip ConfigMap åŠ¨æ€åº”ç”¨

ä¿®æ”¹ ConfigMap åï¼Œå¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤è§¦å‘ Pod é‡æ–°åŠ è½½é…ç½®ï¼š

Bash

```
kubectl rollout restart deployment <app-name>
```

:::

------

## âœ… æ€»ç»“

1. **æ„å»º**ï¼šæ ¹æ®è§„æ¨¡é€‰æ‹©å·¥å…·ï¼Œä½¿ç”¨ `kubeadm` æ ‡å‡†åŒ–åˆå§‹åŒ–ã€‚
2. **äº¤äº’**ï¼šç†Ÿç»ƒæŒæ¡ `kubectl` è¯Šæ–­ä¸‰æ¿æ–§ï¼ˆget, describe, logsï¼‰ã€‚
3. **è‡ªåŠ¨åŒ–**ï¼šé€šè¿‡ `Jenkinsfile` å®šä¹‰æµæ°´çº¿ï¼Œå®ç°ä»ä»£ç åˆ°é•œåƒï¼Œå†åˆ° K8s æ»šåŠ¨å‡çº§çš„é—­ç¯ã€‚

**ç›¸å…³èµ„æºï¼š**

- [Kubernetes Cheat Sheet (å®˜æ–¹ç‰ˆ)](https://kubernetes.io/docs/reference/kubectl/cheatsheet/)
- [Kubernetes å®˜æ–¹æ–‡æ¡£](https://kubernetes.io/zh/docs/home/)
- [Jenkins å®˜æ–¹ç”¨æˆ·æŒ‡å—](https://www.jenkins.io/doc/)
