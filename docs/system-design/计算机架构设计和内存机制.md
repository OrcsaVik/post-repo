
# 计算机架构设计和内存机制

## 1. NUMA (非一致性内存访问) 架构

在现代多路服务器中，NUMA 架构决定了 CPU 访问内存的效率。理解 NUMA 是解决 **JVM 抖动**和**数据库延迟**的底层钥匙。

### 1.1 核心拓扑逻辑

- **Local Access**：CPU 访问直接挂载在本地 Socket 下的内存，延迟最低。
- **Remote Access**：通过 QPI/UPI 总线访问其他 Node 的内存，延迟增加 30%~100%。

### 1.2 性能陷阱

::: danger 性能抖动根源

若系统的 numa_balancing 开启且应用未进行绑核（Affinity），线程在 CPU 间漂移会导致大量的跨节点内存访问，触发缓存一致性风暴，导致 GC STW 时间成倍增加。

:::

------

## 2. 物理内存区域 (Zone) 与碎片管理

Linux 内核为了兼容硬件限制并优化分配效率，将物理内存划分为不同的 Zone。

### 2.1 Zone 划分动机

| **区域名称**     | **核心用途**      | **关键特性**                       |
| ---------------- | ----------------- | ---------------------------------- |
| **ZONE_DMA**     | 兼容老旧设备      | 通常指内存前 16MB 空间。           |
| **ZONE_NORMAL**  | 内核常规操作      | 存储内核数据结构及大部分用户内存。 |
| **ZONE_MOVABLE** | **反碎片/热插拔** | 仅存储可迁移页，防止大页分配失败。 |

### 2.2 内存碎片解决方案：ZONE_MOVABLE

伙伴系统（Buddy System）分配物理页时要求连续性。长期运行后的系统会产生大量空隙。

- **策略**：`ZONE_MOVABLE` 强制只存放可被 Page Migration 移动的页面。
- **收益**：确保系统在长时间运行后，依然能分配出 **Huge Pages (大页)** 供 JVM 或数据库使用。

------

## 3. 内存回收与水位线 (Watermark)

系统在内存压力下如何表现，取决于三条关键水位线的配置。

### 3.1 水位线回收逻辑

1. **HIGH ~ LOW**：内存充足，分配顺畅。

2. **LOW ~ MIN**：触发 `kswapd` 异步回收进程。此时应用层仍有感知，但不会阻塞。

3. < MIN：触发 Direct Reclaim (直接回收)。

   ::: warning 生产预警

   一旦进入直接回收状态，申请内存的线程会被挂起，原地等待内存回收完成。这是 Java 应用出现 Promotion Failed 或 Long GC Pause 的隐形杀手。

   :::

### 3.2 回收对象：文件页 vs 匿名页

- **文件页 (Page Cache)**：由磁盘文件产生，由于磁盘有副本，可以直接丢弃（若为脏页则先写回）。
- **匿名页 (Anonymous Page)**：由堆栈产生，无磁盘背景，回收时**必须**写入 Swap 分区。

------

## 4. 内核核心数据结构：`struct page`

内核通过 `struct page` 数组管理每一块 4KB 物理内存。

### 4.1 节省内存的 Union 设计

由于系统可能有数千万个 `struct page`，该结构体必须极度精简。内核通过 `union` 复用字段：

- 当页面属于 **Slab** 时，字段指向管理元数据。
- 当页面属于 **Page Cache** 时，指向 `address_space` 索引。

### 4.2 反向映射 (Reverse Mapping)

- **匿名页反向映射**：通过 `anon_vma` 和红黑树，内核能在需要 Swap 时，迅速找到所有映射了该物理页的虚拟内存区域（VMA）。这是 Linux 实现高效内存换出的基础。

------

## 5. 对商城系统的工程指导意义

::: tip 调优最佳实践

1. **NUMA 隔离**：高竞争组件（如 Redis/网关）建议使用 `numactl --cpunodebind=0 --membind=0` 锁定资源，消除跨节点延迟。

2. **预留内存**：通过 `vm.min_free_kbytes` 适当调高水位线，让 `kswapd` 提早介入，避免进入 Direct Reclaim。

3. **Swappiness 设置**：对于延迟敏感的 JVM 应用，建议设置 `vm.swappiness = 10`，优先回收 Page Cache 而非 Swap 堆内存。

4. 透明大页 (THP)：在数据库节点建议关闭 THP 或设置为 madvise，防止因大页分配导致的系统级卡顿。

   :::

------

## 🔗 相关配置参数

- 查看拓扑：`numactl -H`
- 水位线查询：`cat /proc/zoneinfo`
- 预留比率：`/proc/sys/vm/lowmem_reserve_ratio`

