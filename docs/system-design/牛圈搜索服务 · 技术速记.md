---
title: 牛圈搜索服务 · 技术速记
---

# 牛圈搜索服务 · 技术速记

**定位**  
用于快速记录牛圈搜索服务涉及的核心中间件、机制与工程实践。  
偏向事实归档与速记，不做概念科普。

## 一、Apache ShardingSphere（使用背景）

- **核心解决**：分布式数据库下的数据分片、路由、读写分离  
- **现有依赖**：
  - spring-boot-starter-jdbc  
  - mybatis-plus-boot-starter  
- **所处位置**：位于 JDBC 层之上、ORM 之下，对业务代码完全透明

## 二、Spring 属性别名机制

### 2.1 @AliasFor

- 包路径：`org.springframework.core.annotation`  
- 作用：声明两个注解属性语义完全等价  
- 重要特性：**双向别名**（设置任一属性均生效）

## 三、Binlog 机制（构建同步能力）

- **主要用途**：数据变更捕获（CDC）  
- **关注操作**：仅 INSERT / UPDATE / DELETE  
- **提取原则**：仅抽取业务关键字段

## 四、Elasticsearch 分页机制

### 4.1 from + size（传统分页）

- 存在硬性限制：`index.max_result_window = 10000`  
- 深分页会导致性能灾难

### 4.2 Scroll

- 适用场景：离线批量导出  
- 限制：不支持跳页

### 4.3 Search After（当前推荐方案）

- 基于上一页最后一条记录的 **sort 值** 进行下一页查询  
- 优点：无深分页性能问题

### 4.4 前端分页深度校验（防护措施）

```java
if (requestParam.getCurrent() * requestParam.getSize() > 10000) {
    throw new ClientException(BaseErrorCode.SEARCH_AMOUNT_EXCEEDS_LIMIT);
}
```

## 五、ES 分页结果修正

**原问题**：
- total 使用当前页记录数  
- pages 使用错误总数计算

**修正后代码**：

```java
pageResult.setRecords(couponTemplatePageQueryRespDTOS);
pageResult.setTotal(docSearchHits.getTotalHits());
pageResult.setPages((long) Math.ceil(docSearchHits.getTotalHits() * 1.0 / requestParam.getSize()));
```

## 六、MyBatis 并发库存扣减

```java
int decrementCouponTemplateStock(
    @Param("shopNumber") Long shopNumber,
    @Param("couponTemplateId") Long couponTemplateId,
    @Param("decrementStock") Long decrementStock);
```

- 依赖：**数据库原子性**  
- 目的：防止超卖

## 七、日志系统（LogRecord）

### 7.1 核心注解字段

| 属性      | 含义             |
| --------- | ---------------- |
| success   | 成功日志模板     |
| fail      | 失败日志模板     |
| operator  | 操作人           |
| type      | 日志大类         |
| subType   | 日志子类         |
| bizNo     | 业务主键         |
| condition | 记录条件（SpEL） |

### 7.2 底层实现机制

- AOP 切面拦截  
- SpEL 表达式解析  
- 日志上下文使用 **ThreadLocal** 存储

## 八、雪花 ID 与日志上下文配合

```java
couponTemplateMapper.insert(couponTemplateDO);
LogRecordContext.putVariable("bizNo", couponTemplateDO.getId());
```

- MyBatis-Plus 默认策略：`IdType.ASSIGN_ID`  
- 插入成功后**自动回填**主键

## 九、Bean 转 Map（常用工具）

- 工具：**Hutool**  
- 特性：基于反射，null 值转为**空字符串**  
- 典型用途：构造 Redis Hash 数据结构

## 十、Redis Hash 库存模型

**Key 格式**：
```
merchant:admin:coupon:template:{id}
```

- 数据结构：**Hash**  
- 库存字段原子操作：
```java
stringRedisTemplate.opsForHash().increment(key, "stock", number);
```

## 十一、线程池策略（适用于可重算任务）

```java
new ThreadPoolExecutor(
    cpu,                    // core
    cpu << 1,               // max
    60L,                    // keep-alive
    TimeUnit.SECONDS,
    new SynchronousQueue<>(),
    new ThreadPoolExecutor.DiscardPolicy()  // 拒绝策略：直接丢弃
)
```

- 适用场景：任务可重算，丢弃无重大影响

## 十二、Fastjson / Fastjson2 兼容性注意

- 包路径完全不同  
- API 存在差异  
- **不可混用**（容易出现序列化/反序列化异常）

## 十三、日志服务扩展能力

- 支持复杂条件查询  
- 支持分页 + 排序  
- 支持批量写入（Bulk / Batch）  
- 支持异步合并提交

## 十四、状态枚举（典型用法）

```java
ACTIVE(0),  // 进行中
ENDED(1)    // 已结束
```

用于标识优惠券等业务实体的生命周期状态

---

