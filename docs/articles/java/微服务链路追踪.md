
# 微服务链路追踪

在分布式架构中，一个请求可能跨越多个服务单元。链路追踪技术旨在解决服务调用链复杂、问题定位难的痛点。

------

## 一、 核心概念

### 1. 为什么需要链路追踪？

微服务数量众多且业务逻辑交织，当请求出现延迟或异常时，开发者难以直观查看到底是哪个环节出了问题。分布式链路追踪通过记录请求在各服务间的调用顺序和耗时，使每个步骤清晰可见。

### 2. 基本术语

- **Span (跨度)**：基本工作单元。每发起一次远程调用（如 RPC、HTTP）都会产生一个 Span，包含唯一的 64 位 ID、摘要、时间戳等。
- **Trace (跟踪)**：由一系列 Span 组成的树状结构，代表一个完整的请求生命周期。
- **Annotation (标注)**：记录事件的关键时间点。
  - `cs` (Client Sent): 客户端发起请求，标记 Span 开始。
  - `sr` (Server Received): 服务端接收并准备处理请求。
  - `ss` (Server Sent): 服务端处理完成并返回响应。
  - `cr` (Client Received): 客户端接收响应，标记 Span 结束。

------

## 二、 整合 Sleuth (日志追踪)

Sleuth 负责在日志中注入追踪信息。

### 1. 引入依赖

在 `common` 模块中添加，确保服务提供者和消费者均能使用：



```XML
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-sleuth</artifactId>
</dependency>
```

### 2. 开启调试日志

在配置文件中设置日志级别，以便观察控制台输出：



```YAML
logging:
  level:
    com.atguigu.gulimall: debug
    org.springframework.cloud.openfeign: debug
    org.springframework.cloud.sleuth: debug
```

------

## 三、 整合 Zipkin (可视化展示)

Zipkin 将 Sleuth 收集的数据进行聚合与可视化展示。

### 1. 部署 Zipkin 服务器

使用 Docker 快速启动：



```Bash
docker run -d -p 9411:9411 --name zipkin openzipkin/zipkin
```

### 2. 服务配置

引入 `spring-cloud-starter-zipkin` 后，配置数据上报地址：



```YAML
spring:
  zipkin:
    base-url: http://192.168.56.10:9411/
    discovery-client-enabled: false # 关闭服务发现以免将其误认为服务名
    sender:
      type: web # 使用 HTTP 方式传输数据
  sleuth:
    sampler:
      rate: 1 # 设置抽样采集率（1.0 代表 100% 采集）
```

### 3. 解决启动死锁问题

针对某些版本可能出现的启动死锁，可自定义采样器配置：

::: details 点击查看配置代码



```Java
@Configuration
public class SleuthSamplerConfiguration {
    @Value("${spring.sleuth.sampler.rate}")
    private String probability;

    @Bean
    public Sampler defaultSampler() {
        Float f = new Float(probability);
        SamplerProperties samplerProperties = new SamplerProperties();
        samplerProperties.setProbability(f);
        return new ProbabilityBasedSampler(samplerProperties);
    }
}
```

:::

------

## 四、 Zipkin 数据持久化 (Elasticsearch)

默认情况下 Zipkin 数据存在内存中，重启即丢失。生产环境建议保存到 Elasticsearch。

### 1. 部署持久化版本



```Bash
docker run -d \
  --name zipkin \
  -p 9411:9411 \
  --env STORAGE_TYPE=elasticsearch \
  --env ES_HOSTS=192.168.56.10:9200 \
  openzipkin/zipkin
```

### 2. 依赖图自动计算




```Bash
docker run -d \
  --env STORAGE_TYPE=elasticsearch \
  --env ES_HOSTS=192.168.56.10:9200 \
  openzipkin/zipkin-dependencies
```

------

## 相关资源链接

- [Spring Cloud Sleuth 官方文档](https://spring.io/projects/spring-cloud-sleuth)
- [快速开始指南](https://docs.spring.io/spring-cloud-sleuth/docs/3.1.0/reference/html/getting-started.html)
- [Zipkin 官网](https://zipkin.io/)

